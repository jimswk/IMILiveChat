<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Client Live Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-storage.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .chat-bubble { max-width: 70%; word-wrap: break-word; }
        .typing-indicator { display: none; font-size: 0.8rem; color: #666; }
        .popup { display: none; position: fixed; top: 20px; right: 20px; background: #fff; border: 1px solid #ccc; padding: 10px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); z-index: 1000; }
    </style>
</head>
<body class="bg-gray-100 h-screen flex flex-col">
    <div class="bg-green-500 text-white p-4 flex justify-between items-center">
        <h1 class="text-lg font-bold">Imigresen Live Chat</h1>
        <span id="officer-status" class="text-sm">Menunggu Pegawai...</span>
    </div>
    <div id="chat-container" class="flex-1 p-4 overflow-y-auto bg-[url('https://source.unsplash.com/random/800x600/?texture')] bg-cover">
        <div id="chat-messages"></div>
        <div id="typing-indicator" class="typing-indicator">Pegawai sedang menaip...</div>
    </div>
    <div class="p-4 bg-white flex items-center space-x-2">
        <input id="message-input" type="text" placeholder="Taip mesej anda..." class="flex-1 p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
        <input id="file-input" type="file" class="hidden">
        <button onclick="document.getElementById('file-input').click()" class="p-2 bg-gray-200 rounded-lg hover:bg-gray-300">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 002.828 2.828L17 10.828V15m0 0v6m0 0H3m18 0V3m0 0h-6"></path></svg>
        </button>
        <button onclick="sendMessage()" class="p-2 bg-green-500 text-white rounded-lg hover:bg-green-600">Hantar</button>
    </div>
    <div id="popup" class="popup"></div>
    <audio id="notification-sound" src="https://cdn.pixabay.com/download/audio/2022/03/24/audio_4f8b317f4e.mp3"></audio>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCFCAmF7o-PAUY0vMvh2F0iPz-3rV6Di3k",
            authDomain: "imilivechat.firebaseapp.com",
            databaseURL: "https://imilivechat-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "imilivechat",
            storageBucket: "imilivechat.firebasestorage.app",
            messagingSenderId: "263072492193",
            appId: "1:263072492193:web:b3d3e04b9e80e7c40d5ee0"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const storage = firebase.storage();

        const clientId = 'client_' + Math.random().toString(36).substr(2, 9);
        let chatId = null;
        let officerName = null;
        let lastActivity = Date.now();
        const inactivityThreshold = 5 * 60 * 1000; // 5 minutes
        let pollingInterval = 1000; // Start with 1-second polling

        // Initialize client in Firebase
        db.ref('clients/' + clientId).set({
            status: 'waiting',
            lastSeen: firebase.database.ServerValue.TIMESTAMP
        });

        // Update last seen periodically
        setInterval(() => {
            db.ref('clients/' + clientId).update({
                lastSeen: firebase.database.ServerValue.TIMESTAMP
            });
        }, 30000);

        // Adjust polling based on activity
        setInterval(() => {
            if (Date.now() - lastActivity > inactivityThreshold) {
                pollingInterval = 5000; // Reduce to 5 seconds
            } else {
                pollingInterval = 1000; // Normal polling
            }
        }, 60000);

        // Listen for chat assignment
        db.ref('clients/' + clientId).on('value', (snapshot) => {
            const data = snapshot.val();
            if (data && data.chatId) {
                chatId = data.chatId;
                officerName = data.officerName;
                document.getElementById('officer-status').textContent = `Berbual dengan ${officerName} â€¢ ${data.officerOnline ? 'Online' : 'Last seen ' + new Date(data.officerLastSeen).toLocaleTimeString()}`;
                loadMessages();
            }
        });

        // Listen for typing indicator
        db.ref('chats/' + chatId + '/typing').on('value', (snapshot) => {
            const typing = snapshot.val();
            document.getElementById('typing-indicator').style.display = typing ? 'block' : 'none';
        });

        // Load messages
        function loadMessages() {
            if (!chatId) return;
            db.ref('chats/' + chatId + '/messages').on('child_added', (snapshot) => {
                const msg = snapshot.val();
                displayMessage(msg);
                playNotificationSound();
            });
        }

        // Send message
        function sendMessage() {
            const input = document.getElementById('message-input');
            const message = input.value.trim();
            if (message && chatId) {
                db.ref('chats/' + chatId + '/messages').push({
                    sender: 'client',
                    message: message,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });
                input.value = '';
                lastActivity = Date.now();
                db.ref('chats/' + chatId + '/typing').set(false);
            } else if (!chatId) {
                showPopup('Sila tunggu pegawai memilih sembang anda.');
            }
        }

        // Handle file upload
        document.getElementById('file-input').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file && chatId) {
                const storageRef = storage.ref('attachments/' + chatId + '/' + file.name);
                storageRef.put(file).then(() => {
                    storageRef.getDownloadURL().then((url) => {
                        db.ref('chats/' + chatId + '/messages').push({
                            sender: 'client',
                            fileUrl: url,
                            fileName: file.name,
                            timestamp: firebase.database.ServerValue.TIMESTAMP
                        });
                        console.log('File uploaded:', file.name);
                    });
                }).catch((error) => {
                    console.error('File upload error:', error);
                    showPopup('Gagal memuat naik fail.');
                });
            } else if (!chatId) {
                showPopup('Sila tunggu pegawai memilih sembang anda.');
            }
        });

        // Display message
        function displayMessage(msg) {
            const chatMessages = document.getElementById('chat-messages');
            const div = document.createElement('div');
            div.className = `chat-bubble p-3 m-2 rounded-lg ${msg.sender === 'client' ? 'bg-green-100 ml-auto' : 'bg-white'}`;
            if (msg.message) {
                div.textContent = msg.message;
            } else if (msg.fileUrl) {
                div.innerHTML = `<a href="${msg.fileUrl}" target="_blank" class="text-blue-500">${msg.fileName}</a>`;
            }
            chatMessages.appendChild(div);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Typing indicator
        document.getElementById('message-input').addEventListener('input', () => {
            if (chatId) {
                db.ref('chats/' + chatId + '/typing').set(true);
                setTimeout(() => db.ref('chats/' + chatId + '/typing').set(false), 2000);
            }
        });

        // Show popup
        function showPopup(message) {
            const popup = document.getElementById('popup');
            popup.textContent = message;
            popup.style.display = 'block';
            setTimeout(() => popup.style.display = 'none', 3000);
        }

        // Play notification sound
        function playNotificationSound() {
            const sound = document.getElementById('notification-sound');
            sound.play().catch((e) => console.error('Sound error:', e));
        }

        // End chat on window close
        window.onbeforeunload = () => {
            if (chatId) {
                db.ref('chats/' + chatId).remove();
                db.ref('clients/' + clientId).remove();
            }
        };
    </script>
</body>
</html>
